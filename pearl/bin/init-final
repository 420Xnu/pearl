#!/bin/sh
SUBSTAGES="$(cat /persist/substages)"
if [ x"$SUBSTAGES" = x"" ]; then
    if [ -e /persist/root ]; then
	SUBSTAGES="root installer"
    else
	SUBSTAGES="root debian"
    fi
fi
linux-init
while true; do
    for SUBSTAGE in $SUBSTAGES; do
	echo "$SUBSTAGE" > /persist/substage
	if [ "$SUBSTAGE" = "root" ]; then
	    init-final-root
	elif [ "$SUBSTAGE" = "installer" ] || [ "$SUBSTAGE" = "debian" ]; then
	    exec init-final-"$SUBSTAGE"
	elif [ "$SUBSTAGE" = "shell" ]; then
	    init-final-shell
	fi
    done
done
