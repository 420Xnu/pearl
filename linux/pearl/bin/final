#!/bin/sh
rm /commfile
cp /boot/linux.modules /persist
cd /
echo "booting Debian" > /var/help/011-boot-action
mkdir -p /tmp/debian
cd /tmp/debian
echo "uncompressing image" > /var/help/011-boot-action
xzcat < /persist/debian.cpio.xz | cpio -id
rm -f init
cp /bin/debian-init init
chmod a+x init
rm -f /persist/debian.cpio.xz
rm -f /persist/payload
cp -a /persist persist
echo "copying modules" > /var/help/011-boot-action
cp -a /boot/linux.modules .
echo "building initrd" > /var/help/011-boot-action
find . | cpio -H newc -o > /persist/debian.cpio
echo final > /persist/stage
cd /
egrep -v 'persist' /file.list > /file.list.new
mv /file.list.new /file.list
find /persist >> /file.list
cat /file.list | cpio -H newc -o > /boot/linux.cpio
/bin/kexec -fix /boot/linux.image --dtb=/sys/firmware/fdt --ramdisk=/boot/linux.cpio --command-line="clk_ignore_unused"
