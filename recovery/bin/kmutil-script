#!/bin/bash
tar cf wifi.tar /usr/share/firmware/wifi
bash ./pack.bash /persist/ wifi.tar >> pearl-debian.macho
while true; do
    echo "Available boot parameters (separate with ';', RET to keep):"
    echo "  no4k            disable automatic switch to 4k resolution"
    echo "  root DEV        automatically boot from device"
    echo "  gadget-mode 0   put USB port 0 (top/left) in gadget mode"
    echo "  gadget-mode 1   put USB port 1 (bottom/right) in gadget mode"
    echo "  delay SECS      delay n seconds before booting automatically"
    nvram pearl > pearl-params
    read DUMMY EXISTING < pearl-params
    echo
    echo "Old boot parameters: $EXISTING"
    (perl ./readline.pm "New boot parameters: " "$EXISTING" || read -e -p "New boot parameters: " PARAMS; echo "$PARAMS") > params < /dev/tty
    PARAMS="$(cat params)"
    echo
    echo "New boot parameters: $PARAMS"
    echo
    echo "Please abort with Ctrl-C if this is incorrect."
    echo
    break;
done
if kmutil configure-boot -c pearl-debian.macho -v /Volumes/Macintosh\ HD < /dev/stdout; then
    if [ -z "$PARAMS" ]; then
	nvram -d pearl
    else
	nvram 'pearl='"$PARAMS"
    fi
    reboot
fi
echo "Since we got here, something went wrong. Did you use bputil and csrutil?"
